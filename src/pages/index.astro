---
import { getCollection } from 'astro:content';
import Layout from '../components/Layout.astro';
import type { AstroComponentFactory } from 'astro/runtime/server/index.js';

let posts = await getCollection('blog');

posts = posts.sort((a, b) => {
  return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
});

// Render returns a component
const postsWithContent = await Promise.all(
    posts.map(async (post) => {
      const Content: AstroComponentFactory = (await post.render()).Content;
      return { ...post, Content };
    })
);

function formatDate(dateStr: string) {
  const date = new Date(dateStr);
  return new Intl.DateTimeFormat('en-GB', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: 'numeric',
    minute: 'numeric',
    hour12: true
  }).format(date);
}
---

<Layout title="My Blog">
  <div class="blog-container">
    {postsWithContent.map(post => {
      const Content = post.Content;
      return (
          <article class="post">
            <h2>{post.data.title}</h2>
            <p class="date">{formatDate(post.data.date)}</p>
            <Content />
          </article>
      );
    })}
  </div>
</Layout>

