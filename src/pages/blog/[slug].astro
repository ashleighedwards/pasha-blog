---
import { getCollection } from 'astro:content';
import Layout from '../../components/Layout.astro';

// Step 1: getStaticPaths() must fetch posts inside itself
export async function getStaticPaths() {
    const allPosts = await getCollection('blog');

    return allPosts.map((post) => ({
        params: { slug: post.slug },
    }));
}

// Step 2: Fetch all posts again to find the current post
const { slug } = Astro.params;
const allPosts = await getCollection('blog'); // fetch again
const post = allPosts.find((p) => p.slug === slug);

if (!post) {
    throw new Error(`Post not found: ${slug}`);
}

function formatDate(dateStr: string) {
    const date = new Date(dateStr);
    return new Intl.DateTimeFormat('en-GB', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: 'numeric',
        minute: 'numeric',
        hour12: true
    }).format(date);
}

const { Content } = await post.render();
---
<Layout title={post.data.title}>
    <article class="blog-post">
        <h1>{post.data.title}</h1>
        <p>{formatDate(post.data.date)}</p>
        <Content />
    </article>
</Layout>
